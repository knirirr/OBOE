
var Mapi;var __mapi;var __map;var __evClick;function loadScript(url,callback)
{var head=document.getElementsByTagName('head')[0];var script=document.createElement('script');script.type='text/javascript';script.src=url;script.onreadystatechange=callback;script.onload=callback;head.appendChild(script);}
function loadTxtFile(file,callback){var xmlhttp;if(window.XMLHttpRequest)
xmlhttp=new XMLHttpRequest();else
xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4&&xmlhttp.status==200)
callback(xmlhttp.responseText);}
xmlhttp.open("GET",file,true);xmlhttp.send();}
__mapiDir="./mapi/";var __mapiIcons=new Object();var __loadedJQ=false;var __loadedOL=false;var __loadedMap=false;Mapi={Load:function(dir,callback){__mapiDir=dir;loadScript("http://openlayers.org/api/OpenLayers.js",function(){loadScript("http://code.jquery.com/jquery-1.7.2.min.js",function(){loadTxtFile(__mapiDir+"icons/config.txt",function(txt){var lines=txt.split("\n");for(var i=0;i<lines.length;++i){var l=lines[i];if(l.indexOf("//")==0)
continue;var icon=l.split(" ");if(icon.length==6){__mapiIcons[icon[0]]={ext:icon[1],w:parseFloat(icon[2]),h:parseFloat(icon[3]),x:parseFloat(icon[4]),y:parseFloat(icon[5])};}}
if(!__loadedMap){loadMapi();callback();__loadedMap=true;}});});});}}
function loadMapi(){OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{'single':true,'double':false,'pixelTolerance':0,'stopSingle':false,'stopDouble':false},initialize:function(options){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{'click':this.trigger},this.handlerOptions);},trigger:function(e){var lonlat=__map.getLonLatFromPixel(e.xy);lonlat.transform(__map.getProjectionObject(),__map.projection);var loc=new Mapi.Loc(lonlat.lat,lonlat.lon);if(typeof __evClick!=='undefined')
__evClick(loc);}});Mapi={Loc:function(lat,lon){this.lon=lon;this.lat=lat;this.ol=function(){var lonlat=new OpenLayers.LonLat(this.lon,this.lat);lonlat.transform(__map.projection,__map.getProjectionObject());return lonlat;}
this.px=function(){return __map.getLayerPxFromViewPortPx(__map.getPixelFromLonLat(this.ol()));}
this.add=function(lat,lon){this.lat+=lat;this.lon+=lon;}
this.clone=function(){return new Mapi.Loc(this.lat,this.lon);}
this.equals=function(loc){return this.lat==loc.lat&&this.lon==loc.lon;}},Icon:function(url,width,height,offsetx,offsety){this.url=url;this.width=width;this.height=height;this.offsetx=offsetx;this.offsety=offsety;this.icon=new OpenLayers.Icon(url,new OpenLayers.Size(width,height),new OpenLayers.Pixel(-width*offsetx,-height*offsety));this.ol=function(){return this.icon;}},Marker:function(loc,icon,controller){this.loc=loc;var t=typeof icon;if(t==="string"){var dir=icon.slice(0,icon.lastIndexOf("/")+1);var ic=__mapiIcons[dir];var url=__mapiDir+"icons/"+icon+ic.ext;this.marker=new OpenLayers.Marker(loc.ol(),new Mapi.Icon(url,ic.w,ic.h,ic.x,ic.y).ol());}
else if(t==="undefined")
this.marker=new OpenLayers.Marker(loc.ol());else
this.marker=new OpenLayers.Marker(loc.ol(),icon.ol().clone());this.ol=function(){return this.marker;}
this.controller=controller;this.moveTo=function(loc){this.loc=loc;this.marker.moveTo(loc.px());}
this.update=function(){this.marker.moveTo(this.loc.px());}},Controller:function(){this.marker;this.update=function(delta){}},Map:function(div){__mapi=this;this.map=__map=new OpenLayers.Map(div,{controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.ArgParser(),new OpenLayers.Control.Attribution()]});this.osm=new OpenLayers.Layer.OSM("OpenStreetMap",null,{transitionEffect:"resize",attribution:""});this.map.addLayer(this.osm);this.map.zoomToMaxExtent();var control=new OpenLayers.Control();OpenLayers.Util.extend(control,{draw:function(){this.box=new OpenLayers.Handler.Box(control,{"done":this.notice},{keyMask:OpenLayers.Handler.MOD_SHIFT});this.box.activate();},notice:function(bounds){}});this.map.addControl(control);this.ol=function(){return this.map;}
this.setCenter=function(loc,zoom,dragging,forceZoomChange){this.map.setCenter(loc.ol(),zoom,dragging,forceZoomChange);}
this.zoomToMaxExtent=function(){this.map.zoomToMaxExtent();}
this.getRoute=function(from,to,callback){var req=__mapiDir+"transport.php?url=http://www.yournavigation.org/api/1.0/gosmore.php&format=geojson";req+="&flat="+from.lat;req+="&flon="+from.lon;req+="&tlat="+to.lat;req+="&tlon="+to.lon;$.get(req,callback);}
this.getClosestRoadLoc=function(loc,callback){var area=0.001;var from=new Array();from[0]=new Mapi.Loc(loc.lat-area,loc.lon);from[1]=new Mapi.Loc(loc.lat+area,loc.lon);from[2]=new Mapi.Loc(loc.lat,loc.lon-area);from[3]=new Mapi.Loc(loc.lat,loc.lon+area);var i=0;var getRoute=this.getRoute;var cb=function(data){if(data.properties.distance>0){var c=data.coordinates;c=c[c.length-1];data.loc=new Mapi.Loc(c[1],c[0]);data.success=true;callback(data);return;}
if(++i<from.length)
getRoute(from[i],loc,cb);else{data.success=false;return callback(data);}}
getRoute(from[i],loc,cb);}
this.layerMarkers=new OpenLayers.Layer.Markers("markers");this.map.addLayer(this.layerMarkers);this.markers=new Array();this.addMarker=function(marker){this.markers.push(marker);this.layerMarkers.addMarker(marker.ol());}
this.clearMarkers=function(){this.markers=new Array();this.layerMarkers.clearMarkers();}
this.removeMarker=function(marker){this.markers=this.markers.splice(this.markers.indexOf(marker),1);this.layerMarkers.removeMarker(marker.ol());}
this.update=function(delta){this.layerMarkers.clearMarkers();this.markers.sort(function(a,b){return b.loc.lat-a.loc.lat});for(var i=0;i<this.markers.length;++i){var m=this.markers[i];if(typeof m.controller!=="undefined"){m.controller.update(m,delta);m.update();}
this.layerMarkers.addMarker(m.ol());}}
window.setInterval("__mapi.update(100/1000)",100);var click=new OpenLayers.Control.Click();this.map.addControl(click);click.activate();this.setEventClick=function(callback){__evClick=callback;}}}}